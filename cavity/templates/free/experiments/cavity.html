{% extends 'free/experiment.html' %}
{% load static %}
{% load i18n %}


{% block experiment_head %}
    <!-- pendulum libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.1/chartjs-plugin-zoom.min.js"></script>

     <!-- slider  -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/slider.min.js"></script>
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/slider.min.css">
 
    <!-- pendulum libraries -->


    <script src="https://unpkg.com/chartjs-chart-error-bars@3.7.2/build/index.umd.min.js"></script>
    <script src="https://d3js.org/d3-array.v3.min.js"></script>


{% endblock %}  


{% block configtab %}
<!-- Begin of the configuration tab-->
    
    
        <div class="ui two column grid container">
            <div class="column">
                <div class="ui segment">
                    <legend> <h3>{% trans 'Start Frequency [MHz]'%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled  slider"  id="slider-f_strat" ></div>
                        
                        <div class="ui input" >
                            <input class="free-input" type="number" id="f_strat">
                        </div>
                </div>
            </div>
            <div class="column">
                <div class="ui segment">
                    <legend><h3>{% trans 'End Frequency [MHz]'%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled  slider" id="slider-f_end" ></div>
                        
                        <div class="ui input">
                            <input class="free-input" type="number" id="f_end">
                        </div>
                </div>
            </div>
        </div>
		<!-- 2 -->
        <div class="ui two column grid container">
            <div class="column">
                <div class="ui segment">
                    <legend> <h3>{% trans 'Step Frequency [MHz]'%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled slider"  id="slider-f_step" ></div>
                        
                        <div class="ui input" >
                            <input class="free-input" type="number" id="f_step">
                        </div>
                </div>
            </div>
			
			 <div class="column">
                <div class="ui segment">
                    <legend> <h3>{% trans 'Number of Iterations'%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled slider"  id="slider-n_iteration" ></div>
                        
                        <div class="ui input" >
                            <input class="free-input" type="number" id="n_iteration">
                        </div>
                </div>
            </div>
           
        </div>
	<!--3-->
	<div class="ui two column grid container">
            	<div class="column">
                	<div class="ui segment">
                    		<legend> <h3>{% trans 'Gas Injection Time [ms]'%}</h3></legend>
                    		<div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled slider"  id="slider-pressure" ></div>
                        
                        	<div class="ui input" >
                            		<input class="free-input" type="number" id="pressure">
                        	</div>
                	</div>
            	</div>
			
		<div class="column">
                	<div class="ui segment">
                    		<legend> <h3>{% trans 'Gas Selection'%}</h3></legend>
					
                    		<div  class="field" id="radio">
                        		<div class="ui  blue radio checkbox langmuir">
                             			<input class="free-input"  type="radio" id="gas_selector" name="gas_type" checked="checked"  value="1">
                                 		<label>Helium</label>
                        		</div>
						
                        		<div class="field">
                            			<div class="ui radio checkbox langmuir">
                                			<input class="free-input"  type="radio" id="gas_selector" name="gas_type"  value="2">
                                    			<label>Nitrogen</label>
                            			</div>
                       			</div>		
						
					<div class="field">
                            			<div class="ui radio checkbox langmuir">
                                			<input class="free-input" type="radio" id="gas_selector"  name="gas_type" value="3">
                                    			<label>Argon</label>
                            			</div>
                        		</div>
							 
				</div>
				<div class="ui toggle checkbox" onclick="change_discharge()">
                            		<input  class="free-input" type="checkbox" name="public"  id="discharge" value='0'>
                            		<label>Discharge</label>
                        	</div>   
                	</div>
            	</div>
           
        </div>
		<!--4-->
	<div class="ui two column grid container">
		<div class="column">
               		<div class="ui segment">
        	        	<legend> <h3>{% trans 'Magnetic Field [T]'%}</h3></legend>
                    		<div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled  slider"  id="slider-magnetic_field" ></div>

                        	<div class="ui input" >
                            		<input class="free-input" type="number" id="magnetic_field">
                        	</div>
                	</div>
            	</div>

            	<div class="column">
                	<div class="ui segment">
                    		<legend> <h3>{% trans 'Background Pressure [Pa]'%}</h3></legend>
                    		<div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled  slider"  id="slider-back_pressure" ></div>
                        
                        	<div  class="ui input" >
                            		<input class="free-input" type="number" id="back_pressure">
                        	</div>
                	</div>
            	</div>
           
        </div>
		
		
		
<!-- End of the configuration tab-->
{% endblock %}



{% block executiontab_ %}
<div class="ui grid stackable">
    <div class="row">
    <div class=" ten wide column">
        <h3>Histogram of the pendulum periods</h3>
       <div>
            <div  id="myplot1"></div>
        </div>
    </div>
</div>
<div class="row">

    <div class=" five wide column">
        <h3>Velocidade Linear vs Amostra</h3>
            <div >
                <div id="myplot"></div>
            </div>
    </div>
    <div class=" five wide column">
        <h3>Period vs. number of samples</h3>
        <div>
            <div  id="myplot2"></div>
        </div>
    </div>
    </div>
</div>
    <table id="results_table" class="ui celled table display" style="width:100%">
        <thead>
            <tr>
                <th id="time">{% trans " Time " %}</th>
                <th id="pressure">{% trans "Pressure [Pa]" %}</th>
		<th id="frequency">{% trans "Frequency [MHz]" %}</th>
            </tr>
        </thead>
    </table>
{% endblock %}


<!-- Begin of the execution tab-->
{% block executiontab %}
<div class="ui grid stackable">
    <div class="row">
        <div class=" ten wide column">
            <h3>Distance vs Time</h3>
                <div >
                    <canvas id="plot_period_histogram"></canvas>
                </div>
        </div>
   
    </div>
	
    <div class="row">
        
        <div class="eight wide column">
            <h3>Velocidade Linear vs Amostra</h3>
                <div >
                    <canvas id="plot_sample_velocity"></canvas>
                </div>
        </div>
        <div class="eight wide column">
            <h3>Velocidade Linear vs Amostra</h3>
                <div >
                    <canvas id="plot_sample_period"></canvas>
                </div>
        </div>
    </div>
</div>

    <table id="results_table" class="ui celled table display" style="width:100%">
        <thead>
            <tr>
		<th id="time">{% trans " Time " %}</th>
                <th id="pressure">{% trans "Pressure [Pa]" %}</th>
                <th id="frequency">{% trans "Frequency [MHz]" %}</th>
                <th id="magnitude">{% trans "Amplitud [dB]" %}</th> 
            </tr>
        </thead>
    </table>
{% endblock %}   
<!-- End of the execution tab-->

		
{% block protocol_auxiliary_functions %}


    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
    var receive_error_velocity
    var receive_error_period

    var plot_sample_velocity
    var plot_sample_period
    var plot_period_histogram
    var period_data = []

function process_experiment_data(data){
	console.log("provavel que funcione")
}


function process_final_data(data_line){


}

function process_partial_data(data_line){
    sample_number = parseInt(data_line.value.time) 
    val3 = parseFloat(data_line.value.pressure)
    val1 = parseFloat(data_line.value.frequency)
   
    plot_sample_velocity.data.datasets[0].data.push({
        x: sample_number, 
        y: val3,
        yMin: val3 - receive_error_velocity,
        yMax: val3 + receive_error_velocity,
    });
    plot_sample_velocity.update();



    period_data.push(val1)

    bin1 = d3.bin()
    histo = bin1(period_data);
    const bins = histo.map((k, i) => (k.x0+ " .. "+k.x1 ));
    const data = histo.map((k, i) => (k.length));
    plot_period_histogram.data.labels = bins
    plot_period_histogram.data.datasets[0].data = data
    plot_period_histogram.update();


    plot_sample_period.data.datasets[0].data.push({
        x: sample_number, 
        y: val1,
        yMin: val1 - receive_error_period,
        yMax: val1 + receive_error_period,
    });
    plot_sample_period.update();

}

function on_save_experiment_UI(){

}





function on_ready_experiment_UI(){

    	configure_slider("f_strat")
	configure_slider("f_end")
	configure_slider("f_step")
	configure_slider("n_iteration")
	configure_slider("pressure")
	configure_radio()
	configure_slider("back_pressure")
	configure_slider("magnetic_field")
	
	
    receive_error_velocity = 0.1;
    receive_error_period = 0.0005;//response.data.value.e_period;

    ctx = $("#plot_sample_velocity")[0].getContext('2d');
    plot_sample_velocity = new Chart(ctx, {
        type: 'scatterWithErrorBars',
        data: {
            datasets: [{
                borderColor: "blue",
                backgroundColor: "blue",
                data: [ ],
            },],
        },
        options: {
            plugins: {
                legend: {
                    display: false,
                }, 
                autocolors: false,
            },
            scales: {
                y: {
                    title:{
                        display: true, 
                        text: gettext('Linear velocity [cm/s]'),
                    },
                    min: 8.5,
                    max: 9.5,
                },
                x: {
                    title:{
                        display: true, 
                        text: gettext('# Samples'),
                    },
                },
            },
        }
    });

    ctx = $("#plot_period_histogram")[0].getContext('2d');
    plot_period_histogram = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                borderColor: "blue",
                backgroundColor: "blue",
                data: [],
            },],
        },
        options: {
            offset: false,
            animation: true,
            scales: {   
                x: {
                    title:{
                        display: true, 
                        text: gettext('Period [s]'),
                    },
                    grid: {
                        offset: true
                        }
                },
                y: {
                    ticks: {
                        beginAtZero: true
                    },
                    
                }
            },
            plugins: {
                legend: {
                    display: false,
                }, 
                autocolors: false,
            },
        }
    });





    ctx = $("#plot_sample_period")[0].getContext('2d');
    plot_sample_period = new Chart(ctx, {
        type: 'scatterWithErrorBars',
        data: {
            datasets: [{
                borderColor: "blue",
                backgroundColor: "blue",
                data: [ ],
            },],
        },
        options: {
            plugins: {
                legend: {
                    display: false,
                }, 
                autocolors: false,
            },
            scales: {
                y: {
                    title:{
                        display: true, 
                        text: gettext('Period [s]'),
                    },
                },
                x: {
                    title:{
                        display: true, 
                        text: gettext('# Samples'),
                    },
                },
            },
        }
    });

}
function configure_slider(name){
        help_spac = 0;
        ticker =  Number.parseFloat(protocol_input_arguments[name].subPart);
	console.log(Object.keys(protocol_input_arguments[name]))
        if(Object.keys(protocol_input_arguments[name]).indexOf("enum") !== -1)
	{
		console.log(name)
		console.log("meuemueu")
		label = protocol_input_arguments[name].enum;
		$('#slider-'+name).slider({
           	 	min:  0,
            		max: label.length-1,
            		step: 1,
            		start: protocol_input_arguments[name].default,
            		input: '#'+name,
            		autoAdjustLabels: false,
			interpretLabel: function (value) {
				return label[value]
			},
			onChange: function( event, ui ) {
            			// Set the real value into the inputs
            			console.log(label[ui]); 
				$('#'+name).val( label[ ui]);


        		},
    			onMove: function(value){ 
				console.log(label[value]); 
				$('#'+name).val( label[value]);
    			}
		})
        	$('#'+name).change(function() {
			thisVal = $(this).val();
   			// o user so pode digitar [0,20,25] isso tem de corresponder to [0,1,2]...

     			if (thisVal >= 0 && thisVal <= label[0])
			{ 
				$("#slider-"+name).slider('set value', label[0]);
   			}
   			else if (thisVal > 6 && thisVal <= label[1]) 
			{ 	
				$("#slider-"+name).slider('set value', label[1]);
  			}
   			else if (thisVal > 20) 
			{ 
				$("#slider-"+name).slider('set value', label[2]);
   			}
   			else 
			{ 
				return false
   			}
 		});


	}
	else{
       		$('#slider-'+name).slider({
            		min:  protocol_input_arguments[name].minimum,
            		max: protocol_input_arguments[name].maximum, 
            		step: protocol_input_arguments[name].multipleOf,
            		start: protocol_input_arguments[name].default,
            		input: '#'+name,
            		autoAdjustLabels: false,
	    		interpretLabel: function (value) { 
            			if (value === 0) 
       				{ 
					if (ticker>Number.parseFloat(protocol_input_arguments[name].minimum))
					{	
						help_spac += (ticker); 	
         	                      	}
					else{
					 	help_spac += (ticker+Number.parseFloat(protocol_input_arguments[name].minimum));
					}
					return Number.parseFloat(protocol_input_arguments[name].minimum);
    				}
   				else if (value + Number.parseFloat(protocol_input_arguments[name].minimum) === help_spac) 
				{ 
				
					help_spac += ticker; 
					return value+Number.parseFloat(protocol_input_arguments[name].minimum)
   				}
   				else if (value + Number.parseFloat( protocol_input_arguments[name].minimum) === Number.parseFloat( protocol_input_arguments[name].maximum)) 	
				{
     					return Number.parseFloat( protocol_input_arguments[name].maximum)
   				}
   				else 
				{ 
					return ""
  				}
  	    			},
            		onChange: function(value) {
                		console.log("QQQQQQQQQQQQQQQQQQ "+value)
                		$('#'+name).prop("value", value)
                		onInputChanged()
           		},
	   		onMove: function(value)
			{
				// var helper = NumberparseFloat(value).toFixed(2);
				$('#'+name).val(value);
			}
        		})
        	$('#'+name).change(function() {
            		if($(this).val() > protocol_input_arguments[name].maximum)
                		$(this).prop("value", protocol_input_arguments[name].maximum)
            		if($(this).val() < protocol_input_arguments[name].minimum)
                		$(this).prop("value", protocol_input_arguments[name].minimum)
            		$("#slider-"+name).slider('set value', $(this).val())
            	});
	}
    }
	
function configure_radio() {
         $('.ui.radio.checkbox').checkbox();
         gas_selector = $('#radio').find('[name="frequency"]:checked').val();
         console.log(gas_selector)
         if (gas_selector === undefined){
                 console.log("error")
                 gas_selector = 1
            }

}

let discharge = 0; 

function change_discharge () { 
	discharge = 1- discharge;
	$('#discharge').val( discharge)
}





function process_partial_data(data_line){
    sample_number = parseInt(data_line.value.Sample_number) 
    val3 = parseFloat(data_line.value.Val3)
    val1 = parseFloat(data_line.value.Val1)
   
 


    Plotly.extendTraces('myplot', {x: [[sample_number]],y: [[val3]],'error_y.array': [[receive_error_velocity]]}, [0,]);
   Plotly.extendTraces('myplot1', {x:  [[val1]]}, [0]);
   Plotly.extendTraces('myplot2', {x: [[sample_number]],y: [[val1]],'error_y.array': [[receive_error_period]]}, [0]);

}





function buildPlot1(res, plotdiv) {

console.log(res);
var trace1 = {
      x: [],
      y: [],
  error_y: {
    type: 'data',
    color: '#85144B',
    array: [],
    thickness: 1.5,
    width:3,
    visible: true
  },
  mode: 'lines+markers',
  line: {
    color: "#1f77b4", 
    width: 1
  },marker: {
    color: "rgb(0, 255, 255)", 
    size: 6, 
    line: {
      color: "black", 
      width: 0.5
    }
  },
  type:"scatter",
      /*line: {
        color: '#80CAF6',
        shape: 'linear'
      },*/
      
      name: "res[1]"
    };

  var output_data = [trace1];

  var layout = {
    margin: {
    l: 50,
    r: 50,
    b: 50,
    t: 50,
    pad: 4
  },
    showlegend:false, 
    xaxis: {
          title: gettext('# Samples'),
          titlefont:{
                color: 'black',
                size: 14
                },
               howticklabels: false
               // rangemode: 'tozero'
              
               //rangeslider: {}
          },
    yaxis: {
          title: gettext('Linear velocity [cm/s]'),
          fixedrange: true,
          titlefont:{
                color: 'black',
                size: 14
                }
               // rangemode: 'tozero'
          }
   };

   Plotly.newPlot(plotdiv, output_data, layout, {responsive: true});
 
}







///////////////////

function buildPlot2(res,plotdiv) {
console.log(res);
var trace2 = {
  // no histograma so é x ou é y.
      x: [],
      //y: [],
  visible: true,
 // mode: 'lines+markers',
  type: 'histogram',
  nbins: 50,
  // xbins: {

  //   end: 1000, 

  //   size: 0.06, 

  //   start: .5

  // },
      line: {
        color: '#80CAF6',
        shape: 'linear'
      },
  opacity:0.5,
      
      name: res[2]
    };

  var output_data = [trace2];

  var layout = {

    bargap: 0.05, 
    bargroupgap: 0.2,
   
  

    xaxis: {
          
          title: gettext('Period [s]'),
          titlefont:{
                color: 'black',
                size: 14
                }
              //  rangemode: 'tozero'
          },
    yaxis: {
      //range:[0.19,0.21],
          title: gettext('# Samples'),
          titlefont:{
                color: 'black',
                size: 14
                }
               // rangemode: 'tozero'
          }
   };

   Plotly.newPlot(plotdiv, output_data, layout, {responsive: true});
 
}


function buildPlot3(res,plotdiv) {
console.log(res);
var trace3 = {
      x: [],
      y: [],
  error_y: {
    type: 'data',
    color: '#85144B',
    array: [],
    thickness: 1.5,
    width:3,
    visible: true
  },
  mode: 'lines+markers',
  line: {
    color: "#1f77b4", 
    width: 1
  },marker: {
    color: "rgb(0, 255, 255)", 
    size: 6, 
    line: {
      color: "black", 
      width: 0.5
    }
  },
  type:"scatter",
      
      name: res[3]
    };

  var output_data = [trace3];

  var layout = {
 

    xaxis: {
          
          title: gettext('# Samples'),
          titlefont:{
                color: 'black',
                size: 14
                }
              //  rangemode: 'tozero'
          },
    yaxis: {
      //range:[0.19,0.21],
          title: gettext('Period [s]'),
          titlefont:{
                color: 'black',
                size: 14
                }
                //rangemode: 'tozero'
          }
   };

   Plotly.newPlot(plotdiv, output_data, layout,  {responsive: true});
 
  }










</script> 
{% endblock %}

